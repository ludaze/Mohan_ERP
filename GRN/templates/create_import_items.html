{% extends "grn_base.html" %}
{% load widget_tweaks %}
{% block content %}
    <h1>Create PR Items</h1>

    <!-- Page Content -->
    <h2 class="text-center">Items Form</h2>
    <br>
    {% if pr_form.errors %}
    <div class="alert alert-danger">
        <strong>Error(s) occurred:</strong>
        <ul>
            {% for field, errors in pr_form.errors.items %}
                {% for error in errors %}
                    <li>{{ field }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
{% endif %}


    <form method="post" action="{% url 'create_import_items' %}" >
        {% csrf_token %}

        {{ formset.management_form }}

        <div id="form-lists">
            {% for form in formset %}
                
                <div class="card-body row item-list form-group col-md-6">
                  
                       {{form.as_p}}
                   
                </div>
           
        {% endfor %}
        </div>
        
        <div id="empty-form" class="hidden"> {{ formset.empty_form.as_p}}</div>
        <button id="add-more" class="btn btn-primary" type="button">Add Item</button>
        
        <div class="col-sm-8">
            <!-- <div class="form-group">
                <label class="control-label col-sm-5" style="margin-top: 10px;">Total Before VAT</label>
                <div class="col-sm-4">
                    <input type="text" class="form-control" name="final_before_vat" readonly>
        
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-5" style="margin-top: 10px;">Total Price</label>
                <div class="col-sm-4">
                    <input type="text" class="form-control" name="final_total_price" readonly>
        
                </div>
            </div> -->
            <div class="form-group">
                <button type="submit"  class="col-sm-2 btn-lg " style="color: #6d7fcc; background-color: white;">
                    Submit
                </button>
                <span style="margin: 10px;"></span>
                <a href="" class="btn btn-default" style="font-size: large; margin-top: 5px;">Cancel</a>
            </div>
           </div>
    </form>
   

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js" integrity="sha384-eMNCOe7tC1doHpGoWe/6oMVemdAVTMs2xqW4mwXrXsW0L84Iytr2wi5v2QjrP/xp" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js" integrity="sha384-cn7l7gDp0eyniUwwAZgrzD06kc/tftFf19TOAs2zVinnD/C7E91j9yyk5//jjpt/" crossorigin="anonymous"></script>
    
    <script>

    document.addEventListener('DOMContentLoaded', function() {
        
        const addMoreBtn = document.getElementById('add-more');
        const totalNewForms = document.getElementById('id_items-TOTAL_FORMS')
        console.log("try")
        
        addMoreBtn.addEventListener('click', add_new_form);
        
        function updateTotalPrice(form) {
            var quantity = parseFloat(form.find('.quantity').val());
            var price = parseFloat(form.find('.price').val());
            var total = quantity * price || 0;
            var total_price = total  + (total * 0.15)
            form.find('.before_vat').val(total.toFixed(2));
            form.find('.total_price').val(total_price.toFixed(2));
        }

        $(document).on('input', '.item-list .quantity, .item-list .price', function () {
            var form = $(this).closest('.item-list');
            updateTotalPrice(form);
        });

        // Apply initial calculation for existing forms
        $('.item-list').each(function () {
            var form = $(this);
            updateTotalPrice(form);
        });
        function add_new_form(args) {
            // Your code to add a new form here
            const currentForms = document.getElementsByClassName('item-list')
            let currentFormsCount = currentForms.length + 1
            console.log(currentForms.length)
            console.log(totalNewForms);
            const copyFormTarget = document.getElementById('form-lists')
            const copyEmptyForm = document.getElementById('empty-form').cloneNode(true);
            copyEmptyForm.setAttribute('class', 'item-list form-group col-md-5 text-dark')
            copyEmptyForm.setAttribute('id', `form-${currentFormsCount}`)
// Clear input values in the cloned form
            const regex = new RegExp('__prefix__','g')
            copyEmptyForm.querySelectorAll('input').forEach(function(input) {
                input.value = '';
            });
            copyEmptyForm.innerHTML = copyEmptyForm.innerHTML.replace(regex,currentFormsCount)
            // Append the cloned form to the form list
            totalNewForms.value = currentFormsCount + 1;
            copyFormTarget.appendChild(copyEmptyForm);
                    }
                });
            
</script>

{% endblock %}