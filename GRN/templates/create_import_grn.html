{% extends "grn_base.html" %}
{% load widget_tweaks %}


{% block content %}
{% if grn_form.errors %}
    <div class="alert alert-danger">
        <strong>Error(s) occurred:</strong>
        <ul>
            {% for field, errors in grn_form.errors.items %}
                {% for error in errors %}
                    <li>{{ field }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
{% endif %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
<div>
    <span class="col-md-3" ></span>
<h1>Create GRN</h1>
</div>


<br>
<form method="post" action="{% url 'create_import_grn' %}" id="form1">
    {% csrf_token %}
    <div class="form-group col-sm-8">
        <label class="control-label col-sm-3" style="margin-top: 10px;">Recieved From</label>
        <div class="col-sm-6">
            <input type="text" class="form-control" name="recieved_from">

        </div>
    </div>
    <div class="col-sm-6">
        <span class="form-group">
            <label class="control-label col-sm-4"> GRN Number</label>
            <div class="col-sm-8">

                <input type="text" class="form-control" name="GRN_no">
            </div>
        </span>
        <div class="form-group">
            <label class="control-label col-sm-4">PR no</label>
            <div class="col-sm-8" style="margin-top: 10px;">
                <input type="text" class="form-control" name="PR_no">

            </div>
        </div>


    </div>

<div>
    <div class="col-sm-5">
        <div class="form-group">
            <label class="control-label col-sm-4">Date</label>
            <div class="col-sm-8">
                <input type="date" name="grn_date" class="form-control datetimepicker-input" data-target="#datepicker1" />
            </div>
        </div>
    </div>
    <div class="col-sm-8"></div>
    <div class="col-sm-6">
        <div class="form-group">
            <label class="control-label col-sm-4">Transporter Name</label>
            <div class="col-sm-8" style="margin-top: 10px;">
                <input type="text" class="form-control" name="transporter_name">

            </div>
        </div>
        <span class="form-group">
            <label class="control-label col-sm-4"> Plate No</label>
            <div class="col-sm-8">

                <input type="text" class="form-control" name="truck_no">
            </div>
        </span>
    </div>

    <div class="col-sm-5">
       

        <div class="form-group" style="margin-bottom: 10px;">
            <label class="control-label col-sm-4" style="margin-top: 10px;">Store Name</label>
            <div class="col-sm-8" style="margin-top: 10px;">
                <input type="text" class="form-control" name="store_name">

            </div>
            <label class="control-label col-sm-4" style="margin-top: 10px;">Store Keeper</label>
            <div class="col-sm-8" style="margin-top: 10px;">
                <input type="text" class="form-control" name="store_keeper">

            </div>
            <!-- <label class="control-label col-sm-4" style="margin-top: 10px;">Invoice Type</label>
          <div class="col-sm-8" style="margin-top: 10px;">
            <input type="text" class="form-control" name="invoice_type">
            
          </div> -->
        </div>
    </div>
    
</div>
<span class="col-sm-4"></span>
      <div style="justify-content: center;">
        <button type="submit"  class="col-sm-2 btn-lg " style="color: #6d7fcc; background-color: white;">
          
          Submit
      </button>
       </div>
</form>
</div></div></div>
<div class="container">
    <div class="row">
        <div class="col-md-12">
            {% if pr_form.errors %}
            <div class="alert alert-danger">
                <strong>Error(s) occurred:</strong>
                <ul>
                    {% for field, errors in pr_form.errors.items %}
                    {% for error in errors %}
                    <li>{{ field }}: {{ error }}</li>
                    {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            <form method="post" action="{% url 'create_import_grn_items' %}" id="form2">
                {% csrf_token %}

                {{ formset.management_form }}

                <div id="form-lists">
                    {% for form in formset %}

                    <div class="item-list card-body row form-group col-md-5">

                        {{form.as_p}}

                    </div>

                    {% endfor %}
                </div>

                <div id="empty-form" class="hidden"> {{ formset.empty_form.as_p}}</div>
                <button id="add-more" class="btn btn-primary" type="button">Add Item</button>

              
            
            </form>
        </div></div></div>

        <button id="submits" class="col-sm-3 btn-lg " style="color: #6d7fcc; background-color: white; margin-left: 100px;">
            Submits
        </button>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                //const radioButtons = document.querySelectorAll('input[type="radio"]');
               
                const submitButton = document.querySelector('#submits');
                const addMoreBtn = document.getElementById('add-more');
               
                const totalNewForms = document.getElementById('id_GRN_items-TOTAL_FORMS')
                console.log(totalNewForms)
                
                addMoreBtn.addEventListener('click', add_new_form);
           
                submitButton.addEventListener('click', function (event) {
                    event.preventDefault(); // Prevent the default form submission
                    
                    // Serialize form data
                    const formData1 = new FormData(form1);
                    const formData2 = new FormData(form2);
        
                   
                    const prNoValue = formData1.get('PR_no');
                    const grnNoValue = formData1.get('GRN_no');
                   
                    console.log(prNoValue)
                    formData2.append('PR_no', prNoValue)
                    formData2.append('GRN_no', grnNoValue)
                    // Use fetch to submit both forms asynchronously
                    fetch(form1.action, {
                        method: 'POST',
                        body: formData1
                    })
                        .then(response => {
                            // Handle the response if needed
                            console.log('Form 1 submitted:', response);
        
                            // Submit the second form asynchronously
                            return fetch(form2.action, {
                                method: 'POST',
                                body: formData2
                            });
                        })
                        .then(response => {
                            // Handle the response for the second form if needed
                            console.log('Form 2 submitted:', response);
                            document.getElementById('form1').reset();
                            document.getElementById('form2').reset();

                            // Reload the page
                            window.location.reload();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                });
             
                function add_new_form(args) {
                    // Your code to add a new form here
                    const currentForms = document.getElementsByClassName('item-list')
                    let currentFormsCount = currentForms.length + 1
                    console.log(currentForms.length)
                    console.log(totalNewForms);
                    const copyFormTarget = document.getElementById('form-lists')
                    const copyEmptyForm = document.getElementById('empty-form').cloneNode(true);
                    copyEmptyForm.setAttribute('class', 'item-list form-group col-md-5 text-dark')
                    copyEmptyForm.setAttribute('id', `form-${currentFormsCount}`)
        // Clear input values in the cloned form
                    const regex = new RegExp('__prefix__','g')
                    copyEmptyForm.querySelectorAll('input').forEach(function(input) {
                        input.value = '';
                    });
                    copyEmptyForm.innerHTML = copyEmptyForm.innerHTML.replace(regex,currentFormsCount)
                    // Append the cloned form to the form list
                    totalNewForms.value = currentFormsCount + 1;
                    copyFormTarget.appendChild(copyEmptyForm);
                            }
                        });
        </script>   
{% endblock %}